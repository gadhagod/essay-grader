<html>
    <head>
        <%- include(`${base}/views/partials/head.ejs`, { title: "Dashboard" }) %>
    </head>
    <body>
        <%- include(`${base}/views/partials/nav.ejs`) %>
        <%- include(`${base}/views/partials/heading.ejs`, { title: "Student Dashboard" }) %>
        <center>
            <div id="before-login" style="display: none;">
                <div id="student-dshbrd-form" class="mt-4 card">
                    <div id="name-input-card" class="card-body">
                        <label for="name-input"><b>Name</b></label>
                        <input id="name-input" class="form-control" name="name" placeholder="Enter name">
                        <a id="name-submit" class="btn btn-primary mt-3">Enter</a>
                    </div>
                </div>
            </div>
            <div id="after-login" style="display: none;">
                <p>Welcome, <span id="student-name-display" class="text-success"></span>!</p>
                <button id="upload-btn" class="btn btn-primary">
                    <i class="bi bi-upload"></i> Upload
                </button>
                <button id="logout-btn" class="btn btn-danger">
                    <i class="bi bi-door-closed"></i> Logout
                </button>

                <h5 class="mt-5">Your essays</h5>
                <table id="student-essay-list" class="table table-sm mx-5" style="display: none;">
                    <tbody>
                        <tr class="table-head mr-1">
                            <th class="text-center"><p>&nbsp;Date</p></th>
                            <th class="text-center"><p>Time</p></th>
                            <th class="text-center"><p>Grade</p></th>
                            <th class="text-center"><p></p></th>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p id="error-indicator" class="mt-3 text-danger" style="display: none"></p>
        </center>
    </body>

    <%- include(`${base}/views/partials/scripts.ejs`) %>
    <script>
        const xhr = new XMLHttpRequest();
        let beforeLogin = document.querySelector("#before-login");
        let afterLogin = document.querySelector("#after-login");
        let essayTable = document.querySelector("table");
        let nameInput = document.querySelector("#name-input");
        let enterBtn = document.querySelector("#name-submit");
        let logoutBtn = document.querySelector("#logout-btn");
        let uploadBtn = document.querySelector("#upload-btn")

        function resetTable() {
            document.querySelectorAll("tr:not(:first-child)").forEach(elem => elem.remove());
        }

        function createTextTd(text) {
            let td = document.createElement("td");
            td.setAttribute("class", "text-center")
            let p = document.createElement("p");
            p.innerHTML = text;
            td.appendChild(p);
            return td;
        }

        let errorIndicator = new ErrorIndicator();

        uploadBtn.onclick = () => { window.location.href = "/upload" };

        enterBtn.onclick = (storedStudentName, ignoreNoName) => {
            errorIndicator.hide();
            let studentName = nameInput.value.trim() || storedStudentName;
            if (!studentName) {
                errorIndicator.setText("Please enter your name.");
                errorIndicator.show();
                return;
            }
            fetch(`/api/essays?${new URLSearchParams({ studentName: studentName })}`, { method: "GET" }).then(async res => {
                essayTable.style.display = "none";
                resetTable();
                let essays = await res.json();
                if (!essays.length) {
                    if (!ignoreNoName) {
                        errorIndicator.setText("Student not found.");
                        errorIndicator.show();
                    }
                    localStorage.removeItem("studentName");
                    beforeLogin.style.display = "";
                    afterLogin.style.display = "none";
                    return;
                };
                afterLogin.style.display = "";
                beforeLogin.style.display = "none";
                beforeLogin.style.display = "none";
                localStorage.setItem("studentName", studentName);
                document.getElementById("student-name-display").innerText = studentName;
                essays.forEach(essay => {
                    essay.creationTime = new Date(essay.creationTime);
                    let row = document.createElement("tr");
                    row.appendChild(createTextTd(`${essay.creationTime.getMonth()}/${essay.creationTime.getDate()}/${essay.creationTime.getYear().toString().slice(-2)}`));
                    row.appendChild(createTextTd(essay.creationTime.toLocaleString("en-US", { hour: "numeric", minute: "numeric", hour12: true })));
                    row.appendChild(createTextTd(essay.grade.letterGrade));
                    row.appendChild(createTextTd(
                        (() => {
                            let a = document.createElement("a");
                            a.setAttribute("href", `/view/${essay._id}`)
                            let btn = document.createElement("button");
                            btn.classList.add("btn", "btn-primary", "text-center");
                            btn.innerText = "View"
                            a.appendChild(btn);
                            return a.outerHTML;
                        })()
                    ));
                    essayTable.appendChild(row);
                });
                essayTable.style.display = "";
            }).catch((err) => {
                console.log(err);
                essayTable.style.display = "none";
                errorIndicator.setText("An error occurred");
                errorIndicator.show();
            });
        };
        
        logoutBtn.onclick = () => {
            localStorage.removeItem("studentName");
            afterLogin.style.display = "none";
            beforeLogin.style.display = "";
        };

        let studentName = localStorage.getItem("studentName");
        if (studentName) {
            console.log("hi")
            enterBtn.onclick(studentName, true);
        } else {
            afterLogin.style.display = "none";
            beforeLogin.style.display = "";
        }
    </script>
</html>